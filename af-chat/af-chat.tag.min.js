riot.tag2("af-chat",'<div class="messages"><div class="messages-content"><div each="{message, index in messages}" class="{message : true, real: true, message-personal : message.from == \'me\'}"><figure class="avatar" if="{message.from != \'me\'}"><img riot-src="{message.avatar}"></figure> {message.text} <div class="timestamp" if="{shouldDisplayTimestamp(index)}">{getTimestamp(message.date)}</div></div><div class="message loading new" if="{typing}"><figure class="avatar"><img riot-src="{typing.avatar}"></figure><span></span></div></div></div><div class="message-box"><textarea type="text" class="message-input" placeholder="Type message..." oninput="{useristyping}"></textarea><button type="submit" class="message-submit" onclick="{send}">Send</button></div>',"","",function(e){var s=this;s.messages=s.opts.messages||[],s.typing=s.opts.typing,s.getTimestamp=function(e){var s=e?new Date(e):new Date,t=s.getMinutes();return t=t<10?"0"+t:t,s.getHours()+":"+t},s.updateScroll=function(){console.log("updateScroll");var e=s.root.getElementsByClassName("messages-content")[0];e.scrollTop=e.scrollHeight},s.send=function(){var e=s.root.getElementsByClassName("message-input")[0],t=e.value.trim();t.length>0&&s.opts.bus&&s.opts.bus.trigger("sendMessage",t),e.value=""},s.useristyping=function(){s.opts.bus&&s.opts.bus.trigger("user_typing")},s.on("updated",function(){setTimeout(s.updateScroll,100)}),s.on("mount",function(){setTimeout(s.updateScroll,100)}),s.opts.bus&&s.opts.bus.on("newMessage",function(e,t){s.messages.push(e),s.messages.sort(function(e,s){return e.date-s.date}),t&&(s.typing=null),setTimeout(function(){var e=s.root.getElementsByClassName("real");e[e.length-1].className+=" new"},1),s.update()}),s.opts.bus&&s.opts.bus.on("newTyping",function(e){s.typing=e,s.update()}),s.shouldDisplayTimestamp=function(e){var t=s.messages[e].date;return!!t&&(e>0&&Math.abs(s.messages[e-1].date-t)>6e4||0==e)}});