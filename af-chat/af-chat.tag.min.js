riot.tag2("af-chat",'<div class="messages"><div class="messages-content"><div each="{message, index in messages}" class="{message : true, real: true, message-personal : message.from == \'me\'}"><figure class="avatar" if="{message.from != \'me\'}"><img riot-src="{message.avatar}"></figure> {message.text || JSON.stringify(message)} <div class="timestamp" if="{shouldDisplayTimestamp(index)}">{getTimestamp(message.date)}</div></div><div class="{message : true, loading  : true, new : true, message-personal : typing.from == \'me\'}" if="{typing}"><figure class="avatar" if="{typing.avatar}"><img riot-src="{typing.avatar}"></figure><span></span></div></div></div><div class="message-box"><textarea type="text" class="message-input" placeholder="Type message..." oninput="{useristyping}"></textarea><button type="submit" class="message-submit" onclick="{send}">Send</button></div>',"","",function(e){function s(e,s){for(e.push(s),i=e.length-1,item=e[i];i>0&&item.date<e[i-1].date;)e[i]=e[i-1],i-=1;return e[i]=item,e}var t=this;t.messages=t.opts.messages&&t.opts.messages.slice()||[],t.typing=t.opts.typing,t.getTimestamp=function(e){var s=new Date,t=e?new Date(e):s,a=t.getMinutes();return a=a<10?"0"+a:a,t.toDateString()!=s.toDateString()?t.toDateString().slice(0,-5)+" "+t.getHours()+":"+a:t.getHours()+":"+a},t.updateScroll=function(){console.log("updateScroll");var e=t.root.getElementsByClassName("messages-content")[0];e.scrollTop=e.scrollHeight},t.send=function(){var e=t.root.getElementsByClassName("message-input")[0],s=e.value.trim();s.length>0&&t.opts.bus&&t.opts.bus.trigger("sendMessage",s),e.value=""},t.useristyping=function(){t.opts.bus&&t.opts.bus.trigger("user_typing")},t.on("updated",function(){setTimeout(t.updateScroll,100)}),t.on("mount",function(){setTimeout(t.updateScroll,100)}),t.opts.bus&&t.opts.bus.on("newMessage",function(e,a){s(t.messages,e),a&&(t.typing=null),setTimeout(function(){var e=t.root.getElementsByClassName("real");1==e[e.length-1].className.split(" new").length&&(e[e.length-1].className+=" new")},100),t.update()}),t.opts.bus&&t.opts.bus.on("newTyping",function(e){t.typing=e,t.update()}),t.shouldDisplayTimestamp=function(e){var s=t.messages[e].date;return!!s&&(e>0&&Math.abs(t.messages[e-1].date-s)>6e4||0==e)}});